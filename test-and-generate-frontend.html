<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test et G√©n√©ration Frontend Impay√©s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Test et G√©n√©ration Frontend Impay√©s</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">üéØ Objectif</h2>
            <p class="text-gray-600 mb-4">
                Ce test permet de r√©cup√©rer les colonnes de la classe impay√©s et de g√©n√©rer le code HTML n√©cessaire 
                pour les int√©grer dans l'interface de d√©tails des s√©quences.
            </p>
            <button onclick="runTestAndGenerate()"
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                Ex√©cuter le test et g√©n√©rer le code
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">üìä R√©sultats</h2>
            
            <div id="loading" class="hidden text-blue-600 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path>
                    </svg>
                    <span>Chargement en cours...</span>
                </div>
            </div>

            <div id="error" class="hidden bg-red-100 text-red-800 p-4 rounded-md mb-4"></div>
            <div id="success" class="hidden bg-green-100 text-green-800 p-4 rounded-md mb-4"></div>

            <div id="results" class="hidden">
                <h3 class="font-semibold text-gray-700 mb-3">Colonnes disponibles ({{ columnsCount }})</h3>
                <div id="columnsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-6"></div>
                
                <h3 class="font-semibold text-gray-700 mb-3">Code HTML g√©n√©r√©</h3>
                <div class="bg-gray-100 p-4 rounded-md mb-4">
                    <pre id="htmlCode" class="text-sm overflow-x-auto"></pre>
                </div>
                
                <button onclick="copyHTMLCode()"
                        class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                    Copier le code HTML
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">üìã Instructions d'int√©gration</h2>
            <div class="space-y-4 text-sm text-gray-600">
                <p>1. Ex√©cutez le test en cliquant sur le bouton ci-dessus</p>
                <p>2. Copiez le code HTML g√©n√©r√©</p>
                <p>3. Ouvrez le fichier <code>/public/app/relances/sequence/index.html</code></p>
                <p>4. Trouvez la section o√π vous voulez ajouter les colonnes</p>
                <p>5. Collez le code HTML g√©n√©r√©</p>
                <p>6. Assurez-vous que les variables Alpine.js sont correctement d√©finies</p>
                <p>7. Testez l'interface pour v√©rifier que tout fonctionne</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration Parse
        const parseConfig = {
            appId: 'marki',
            javascriptKey: 'Careless7-Gore4-Guileless0-Jogger5-Clubbed9',
            serverURL: 'https://dev.parse.markidiags.com'
        };

        // Initialiser Parse
        Parse.initialize(parseConfig.appId, parseConfig.javascriptKey);
        Parse.serverURL = parseConfig.serverURL;

        // Variables globales
        let currentColumns = [];
        let currentFields = {};
        let generatedHTML = '';

        async function runTestAndGenerate() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const results = document.getElementById('results');
            const columnsList = document.getElementById('columnsList');
            const htmlCode = document.getElementById('htmlCode');

            // R√©initialiser
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            success.classList.add('hidden');
            results.classList.add('hidden');
            error.textContent = '';
            success.textContent = '';
            columnsList.innerHTML = '';
            htmlCode.textContent = '';
            currentColumns = [];
            currentFields = {};
            generatedHTML = '';

            try {
                console.log('üîç R√©cup√©ration des colonnes...');

                // R√©cup√©rer le sch√©ma
                const schemas = await Parse.Schema.all();
                const impayesSchema = schemas.find(cls => cls.className === 'impayes');

                if (!impayesSchema) {
                    throw new Error('Classe impayes non trouv√©e');
                }

                const fields = impayesSchema.fields;
                const columns = Object.keys(fields);

                currentColumns = columns;
                currentFields = fields;

                console.log('‚úÖ Colonnes r√©cup√©r√©es:', columns.length);

                // Afficher les colonnes
                displayColumns(columns, fields);

                // G√©n√©rer le code HTML
                generatedHTML = generateHTMLCode(columns, fields);
                htmlCode.textContent = generatedHTML;

                // Afficher les r√©sultats
                results.classList.remove('hidden');
                success.textContent = `‚úÖ ${columns.length} colonnes r√©cup√©r√©es et code HTML g√©n√©r√© !`;
                success.classList.remove('hidden');

            } catch (err) {
                console.error('‚ùå Erreur:', err);
                error.textContent = '‚ùå Erreur: ' + err.message;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function displayColumns(columns, fields) {
            const columnsList = document.getElementById('columnsList');
            columnsList.innerHTML = '';

            columns.forEach(col => {
                const field = fields[col];
                const fieldType = field.type || 'inconnu';
                const isRequired = field.required || false;

                const columnElement = document.createElement('div');
                columnElement.className = 'bg-blue-100 text-blue-800 px-3 py-2 rounded-md text-sm';
                columnElement.innerHTML = `
                    <strong>${col}</strong> 
                    <span class="text-xs bg-blue-200 px-1 rounded">${fieldType}</span>
                    ${isRequired ? '<span class="text-xs bg-red-200 px-1 rounded">Requis</span>' : ''}
                `;
                columnsList.appendChild(columnElement);
            });

            // Mettre √† jour le compteur
            document.getElementById('columnsCount').textContent = columns.length;
        }

        function generateHTMLCode(columns, fields) {
            let htmlCode = '<!-- Colonnes de la classe impayes -->\n';
            htmlCode += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">\n';

            columns.forEach(col => {
                const field = fields[col];
                const fieldType = field.type || 'String';
                const isRequired = field.required || false;

                htmlCode += `    <!-- Colonne: ${col} -->\n`;
                htmlCode += `    <div class="bg-white border border-gray-200 rounded-lg p-4">\n`;
                htmlCode += `        <label class="block text-sm font-medium text-gray-700 mb-1">${col}</label>\n`;

                // G√©n√©rer le champ appropri√© en fonction du type
                if (fieldType === 'String') {
                    htmlCode += `        <input type="text" x-model="sequence.${col}" \n`;
                    htmlCode += `               class="w-full p-2 border border-gray-300 rounded-md text-sm" \n`;
                    htmlCode += `               placeholder="Entrez ${col}">\n`;
                } else if (fieldType === 'Number') {
                    htmlCode += `        <input type="number" x-model="sequence.${col}" \n`;
                    htmlCode += `               class="w-full p-2 border border-gray-300 rounded-md text-sm" \n`;
                    htmlCode += `               placeholder="Entrez ${col}">\n`;
                } else if (fieldType === 'Boolean') {
                    htmlCode += `        <select x-model="sequence.${col}" \n`;
                    htmlCode += `                class="w-full p-2 border border-gray-300 rounded-md text-sm">\n`;
                    htmlCode += `            <option value="true">Oui</option>\n`;
                    htmlCode += `            <option value="false">Non</option>\n`;
                    htmlCode += `        </select>\n`;
                } else if (fieldType === 'Date') {
                    htmlCode += `        <input type="date" x-model="sequence.${col}" \n`;
                    htmlCode += `               class="w-full p-2 border border-gray-300 rounded-md text-sm">\n`;
                } else {
                    // Type par d√©faut
                    htmlCode += `        <input type="text" x-model="sequence.${col}" \n`;
                    htmlCode += `               class="w-full p-2 border border-gray-300 rounded-md text-sm" \n`;
                    htmlCode += `               placeholder="${col} (${fieldType})">\n`;
                }

                htmlCode += `    </div>\n`;
            });

            htmlCode += '</div>\n';

            return htmlCode;
        }

        function copyHTMLCode() {
            if (!generatedHTML) {
                alert('Aucun code HTML √† copier. Veuillez d\'abord ex√©cuter le test.');
                return;
            }

            navigator.clipboard.writeText(generatedHTML).then(() => {
                const success = document.getElementById('success');
                success.textContent = '‚úÖ Code HTML copi√© dans le presse-papiers !';
                success.classList.remove('hidden');
                
                // Masquer le message apr√®s 3 secondes
                setTimeout(() => {
                    success.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                alert('Erreur lors de la copie dans le presse-papiers.');
            });
        }

        // Exposer les fonctions globalement
        window.runTestAndGenerate = runTestAndGenerate;
        window.copyHTMLCode = copyHTMLCode;
        window.getCurrentColumns = () => currentColumns;
        window.getCurrentFields = () => currentFields;
        window.getGeneratedHTML = () => generatedHTML;
    </script>
</body>
</html>