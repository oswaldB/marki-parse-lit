
# produit relances automatiques
---

| **ID** | **Titre**                                      | **Acteur**               | **Description**                                                                                                                                                                                                                     | **Préconditions**                     | **Postconditions**                                                                 |
|--------|------------------------------------------------|--------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|-----------------------------------------------------------------------------------|
| **UC1**  | Synchroniser les impayés depuis Marki Mirroir   | Système                  | Synchronise les données depuis Marki Mirroir vers la table `impayes`. Les impayés avec emails manquants (particulier/apporteur) sont listés sur une **page dédiée** pour mise à jour manuelle.                                                     | Connexion à Marki Mirroir établie.    | Table `impayes` mise à jour, page des emails manquants générée.                  |
| **UC2**  | Créer une liste manuelle                       | Utilisateur (PM/Dev)     | Crée une liste manuelle via des filtres ou **ajoute/supprime des impayés en batch** (sélection multiple).                                                                                                                           | Table `impayes` peuplée.             | Liste manuelle créée, impayés ajoutés/supprimés.                                |
| **UC3**  | Modifier une liste manuelle                    | Utilisateur (PM/Dev)     | Modifie une liste manuelle : filtres, nom, ou **ajoute/supprime des impayés en batch**.                                                                                                                                           | Liste manuelle existante.             | Liste mise à jour.                                                                |
| **UC4**  | Créer une liste automatique                    | Utilisateur (PM/Dev)     | Configure une liste automatique via un **écran dédié** (ex: `statut = "impayé" AND jours_retard > 30`). Un script peuple automatiquement cette liste depuis `impayées`.                                                                   | Table `impayées` peuplée.             | Liste automatique créée et peuplée.                                             |
| **UC5**  | Supprimer une liste                            | Utilisateur (PM/Dev)     | Supprime une liste (manuelle ou automatique). Les impayés associés retournent dans le pool général.                                                                                                                               | Liste existante.                      | Liste supprimée, impayés dissociés.                                               |
| **UC6**  | Créer une séquence d’emails                    | Utilisateur (PM/Dev)     | Crée une séquence avec des **templates dynamiques** (variables `{{variable}}` issues de `impayées` ou `config.json`) et des délais. **Prompts ChatGPT** sont proposés pour aider à rédiger les templates.                                                   | Accès aux templates et `config.json`. | Séquence créée.                                                                   |
| **UC7**  | Associer une liste à une séquence              | Utilisateur (PM/Dev)     | Associe une liste (manuelle/automatique) à une séquence.                                                                                                                                                                           | Liste et séquence existantes.         | Association enregistrée.                                                         |
| **UC8**  | Activer une séquence                           | Utilisateur (PM/Dev)     | Génère les actions dans `relances-actions` pour **tous les impayés de la liste**, en remplaçant les variables des templates par les valeurs réelles.                                                                                             | Liste et séquence associées.          | Table `relances-actions` peuplée.                                                |
| **UC9**  | Désactiver une séquence                        | Utilisateur (PM/Dev)     | Supprime **toutes les actions non envoyées** dans `relances-actions` pour cette séquence.                                                                                                                                         | Séquence active.                      | Actions non envoyées supprimées, séquence désactivée.                          |
| **UC10** | Modifier une séquence                          | Utilisateur (PM/Dev)     | Modifie les templates ou les délais. Les changements **ne s’appliquent pas** aux actions déjà générées.                                                                                                                           | Séquence existante.                   | Séquence mise à jour.                                                            |
| **UC11** | Envoyer les emails quotidiens                  | Système                  | À 18h, vérifie les impayés dans `relances-actions`. Si le statut est "impayé", envoie l’email et met à jour le statut.                                                                                                               | Table `relances-actions` peuplée.     | Emails envoyés, statuts mis à jour.                                              |
| **UC12** | Gérer les échecs d’envoi                       | Système                  | En cas d’échec, envoie un email d’alerte à `email_notification` (défini dans `.env`). **Pas de réessai automatique**.                                                                                                               | UC11 en cours.                        | Email d’alerte envoyé, statut "erreur".                                          |
| **UC14** | Visualiser le calendrier des relances          | Utilisateur (PM/Dev)     | Filtre et visualise les emails (envoyés/à envoyer) dans un calendrier interactif.                                                                                                                                                 | Données dans `relances-actions`.      | Calendrier affiché avec filtres appliqués.                                       |
| **UC15** | Modifier un email via un drawer                | Utilisateur (PM/Dev)     | Modifie un email (contenu, date, destinataire) via un **drawer** depuis le calendrier. Les variables du template sont recalculées si nécessaire.                                                                                     | Email sélectionné.                    | Email mis à jour dans `relances-actions`.                                        |
| **UC16** | Consulter la page des emails manquants         | Utilisateur (PM/Dev)     | Accède à une **page dédiée** listant les impayés avec emails manquants. Mise à jour manuelle **directement dans Marki Mirroir**.                                                                                                     | Synchronisation (UC1) exécutée.      | Mise à jour manuelle dans Marki Mirroir (hors scope du système).                 |

---
**Règle métier** :
*Un impayé ne peut appartenir qu’à **une seule liste** à la fois.*