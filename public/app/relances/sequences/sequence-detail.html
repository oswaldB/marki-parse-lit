<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relances - D√©tail de la s√©quence</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="/components/parse-credentials.js"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script type="module">
    import { LitElement, html } from 'https://cdn.jsdelivr.net/npm/lit@2.0.0/+esm';
    window.lit = { LitElement, html };
  </script>
  <style>
    .action-card {
      transition: all 0.2s ease;
    }
    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="bg-gray-100" x-data="sequenceDetailState()" x-init="init()">
  <!-- Formes originales en arri√®re-plan -->
  <galet-component></galet-component>
  <galet-component-dark></galet-component-dark>
  <galet-component-wide></galet-component-wide>
  
  <relance-sidebar currentPage="sequences"></relance-sidebar>
  
  <!-- Import des composants Lit pour les galets -->
  <script type="module" src="/components/galet-component.js"></script>
  <script type="module" src="/components/galet-component-dark.js"></script>
  <script type="module" src="/components/galet-component-wide.js"></script>
  
  <div class="p-4 sm:ml-64">
    <div class="main-content flex-1">
      <!-- En-t√™te -->
      <div class="w-full bg-gray-100 z-10">
        <div class="flex-1 p-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h1 class="text-2xl font-bold" x-text="sequence ? sequence.nom : 'Chargement...'"></h1>
              <p class="text-gray-500 mt-1" x-show="sequence">
                <span x-text="sequence.actions ? sequence.actions.length + ' action(s)' : '0 action'"></span>
                ‚Ä¢ 
                <span x-text="sequence.isActif ? 'Active' : 'Inactive'"></span>
              </p>
            </div>
            <div class="flex space-x-2">
              <a href="/app/relances/sequences/"
                 class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                Retour √† la liste
              </a>
              <button @click="toggleSequenceStatus()"
                      class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                      :class="sequence && sequence.isActif ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'"
                      x-show="sequence">
                <span x-text="sequence.isActif ? 'D√©sactiver' : 'Activer'"></span>
              </button>
              <button @click="openEditModal()"
                      class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-md text-sm font-medium hover:bg-yellow-200 transition-colors"
                      x-show="sequence">
                Modifier
              </button>
            </div>
          </div>
          
          <p class="text-gray-700 mb-6" x-show="sequence && sequence.description" x-text="sequence.description"></p>
        </div>
      </div>
      
      <!-- Contenu principal -->
      <div class="pt-4 pl-4">
        <template x-if="!sequence">
          <div class="text-center text-gray-500 py-8">
            <p>Chargement de la s√©quence...</p>
          </div>
        </template>
        
        <template x-if="sequence">
          <!-- Section des actions -->
          <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-6">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-xl font-bold">Actions de la s√©quence</h2>
              <p class="text-gray-500 text-sm mt-1">Liste des messages et leurs d√©lais d'envoi</p>
            </div>
            
            <div class="p-6">
              <template x-if="sequence.actions && sequence.actions.length > 0">
                <div class="space-y-4">
                  <template x-for="(action, index) in sequence.actions" :key="index">
                    <div class="action-card bg-gray-50 border border-gray-200 rounded-md p-4">
                      <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-3">
                          <span class="text-2xl" x-text="getActionIcon(action.type)"></span>
                          <div>
                            <h3 class="font-bold" x-text="formatActionType(action.type)"></h3>
                            <p class="text-sm text-gray-500">Envoy√© apr√®s <span x-text="action.delay"></span> jour(s)</p>
                          </div>
                        </div>
                        <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                          Action <span x-text="index + 1"></span>
                        </span>
                      </div>
                      <div class="bg-white border border-gray-100 rounded-md p-3">
                        <p class="whitespace-pre-wrap" x-text="action.message"></p>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
              
              <template x-if="!sequence.actions || sequence.actions.length === 0">
                <div class="text-center text-gray-500 py-4">
                  <p>Aucune action d√©finie pour cette s√©quence.</p>
                </div>
              </template>
            </div>
          </div>
          
          <!-- Section des informations suppl√©mentaires -->
          <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200">
              <h2 class="text-xl font-bold">Informations suppl√©mentaires</h2>
            </div>
            
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-600 mb-1">ID de la s√©quence</p>
                  <p class="font-mono text-sm" x-text="sequence.objectId"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600 mb-1">Date de cr√©ation</p>
                  <p class="text-sm" x-text="formatDate(sequence.createdAt)"></p>
                </div>
                <div>
                  <p class="text-sm text-gray-600 mb-1">Date de mise √† jour</p>
                  <p class="text-sm" x-text="formatDate(sequence.updatedAt)"></p>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
  
  <!-- Modal d'√©dition -->
  <template x-if="showEditModal && sequence">
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.away="closeEditModal">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" @click.stop>
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Modifier la s√©quence</h2>
            <button @click="closeEditModal" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la s√©quence</label>
              <input type="text" x-model="editingSequence.nom" placeholder="Ex: Relance standard"
                     class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea x-model="editingSequence.description" placeholder="Description de la s√©quence..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        rows="3"></textarea>
            </div>
            
            <div class="flex items-center space-x-2">
              <input type="checkbox" x-model="editingSequence.isActif" id="editIsActif" class="rounded">
              <label for="editIsActif" class="text-sm text-gray-700">S√©quence active</label>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Actions de la s√©quence</label>
              
              <!-- Liste des actions -->
              <div class="space-y-3 mb-4">
                <template x-for="(action, index) in editingSequence.actions" :key="index">
                  <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex items-center space-x-2">
                        <span class="text-lg" x-text="getActionIcon(action.type)"></span>
                        <span class="font-medium" x-text="formatActionType(action.type)"></span>
                        <span class="text-sm text-gray-500">Jour <span x-text="action.delay"></span></span>
                      </div>
                      <button @click="removeEditAction(index)" class="text-red-400 hover:text-red-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                    <div class="ml-6">
                      <textarea x-model="action.message" placeholder="Message de l'action..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                rows="3"></textarea>
                    </div>
                  </div>
                </template>
              </div>
              
              <!-- Formulaire d'ajout d'action -->
              <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
                <h4 class="font-medium mb-2">Ajouter une nouvelle action</h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select x-model="newAction.type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="email">Email</option>
                      <option value="sms">SMS</option>
                    </select>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">D√©lai (jours)</label>
                    <input type="number" x-model="newAction.delay" min="0" placeholder="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                    <textarea x-model="newAction.message" placeholder="Contenu du message..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                              rows="3"></textarea>
                  </div>
                  
                  <button @click="addEditAction()"
                          class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-colors">
                    Ajouter l'action
                  </button>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
              <button @click="closeEditModal"
                      class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                Annuler
              </button>
              <button @click="updateSequence()"
                      class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
                      :disabled="!editingSequence.nom || editingSequence.actions.length === 0">
                Mettre √† jour la s√©quence
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
  
  <script type="module" src="/components/relance-sidebar.js"></script>
  
  <script>
    function sequenceDetailState() {
      return {
        sequence: null,
        showEditModal: false,
        editingSequence: null,
        newAction: {
          type: 'email',
          message: '',
          delay: 0
        },
        
        init() {
          // Initialisation du SDK Parse avec la configuration
          if (window.parseConfig) {
            Parse.initialize(window.parseConfig.appId, window.parseConfig.javascriptKey);
            Parse.serverURL = window.parseConfig.serverURL;
          }
          
          // Extraire l'ID de la s√©quence de l'URL
          const pathParts = window.location.pathname.split('/');
          const sequenceId = pathParts[pathParts.length - 1];
          
          if (sequenceId) {
            this.fetchSequence(sequenceId);
          }
        },
        
        async fetchSequence(sequenceId) {
          try {
            const Sequences = Parse.Object.extend('sequences');
            const query = new Parse.Query(Sequences);
            
            const sequence = await query.get(sequenceId);
            
            this.sequence = {
              ...sequence.toJSON(),
              objectId: sequence.id,
              createdAt: sequence.createdAt,
              updatedAt: sequence.updatedAt
            };
            
            console.log('S√©quence r√©cup√©r√©e:', this.sequence);
          } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration de la s√©quence:', error);
          }
        },
        
        openEditModal() {
          this.editingSequence = {
            ...this.sequence,
            actions: JSON.parse(JSON.stringify(this.sequence.actions)) // Deep copy
          };
          this.showEditModal = true;
        },
        
        closeEditModal() {
          this.showEditModal = false;
          this.editingSequence = null;
        },
        
        addEditAction() {
          this.editingSequence.actions.push({...this.newAction});
          this.newAction = {type: 'email', message: '', delay: 0};
        },
        
        removeEditAction(index) {
          this.editingSequence.actions.splice(index, 1);
        },
        
        async updateSequence() {
          try {
            const Sequences = Parse.Object.extend('sequences');
            const sequence = new Sequences();
            sequence.id = this.editingSequence.objectId;
            
            sequence.set('nom', this.editingSequence.nom);
            sequence.set('description', this.editingSequence.description);
            sequence.set('isActif', this.editingSequence.isActif);
            sequence.set('actions', this.editingSequence.actions);
            
            await sequence.save();
            
            this.closeEditModal();
            await this.fetchSequence(this.editingSequence.objectId);
            
            console.log('S√©quence mise √† jour avec succ√®s');
          } catch (error) {
            console.error('Erreur lors de la mise √† jour de la s√©quence:', error);
          }
        },
        
        async toggleSequenceStatus() {
          try {
            const Sequences = Parse.Object.extend('sequences');
            const sequence = new Sequences();
            sequence.id = this.sequence.objectId;
            
            sequence.set('isActif', !this.sequence.isActif);
            
            await sequence.save();
            
            await this.fetchSequence(this.sequence.objectId);
            
            console.log('Statut de la s√©quence mis √† jour');
          } catch (error) {
            console.error('Erreur lors de la mise √† jour du statut:', error);
          }
        },
        
        formatActionType(type) {
          return type === 'email' ? 'Email' : 'SMS';
        },
        
        getActionIcon(type) {
          return type === 'email' ? 'üìß' : 'üì±';
        },
        
        formatDate(date) {
          if (!date) return 'N/A';
          return new Date(date).toLocaleString();
        }
      };
    }
  </script>
</body>
</html>